name: Build and publish Docker images (test-workflow)

on:
    push:
        tags:
            - "v*"
        branches:
            - "test-workflow" # TODO: remove it before merge

jobs:
    publish-backend:
        runs-on: ${{ matrix.runner }}
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix:
                include:
                    - runner: ubuntu-latest
                      platform: linux/amd64
                      arch: amd64
                    - runner: ubuntu-24.04-arm
                      platform: linux/arm64
                      arch: arm64

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push backend (${{ matrix.arch }})
              uses: docker/build-push-action@v6
              with:
                  context: ./backend
                  file: ./backend/Dockerfile
                  platforms: ${{ matrix.platform }}
                  push: true
                  tags: |
                      kuncodes/ferron-proxy-manager-backend:${{ github.ref_name }}-${{ matrix.arch }}
                      kuncodes/ferron-proxy-manager-backend:latest-${{ matrix.arch }}

    publish-backend-manifest:
        needs: publish-backend
        runs-on: ubuntu-latest
        steps:
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Create backend multi-arch manifests
              run: |
                  docker buildx imagetools create \
                    -t kuncodes/ferron-proxy-manager-backend:${GITHUB_REF_NAME} \
                    -t kuncodes/ferron-proxy-manager-backend:latest \
                    kuncodes/ferron-proxy-manager-backend:${GITHUB_REF_NAME}-amd64 \
                    kuncodes/ferron-proxy-manager-backend:${GITHUB_REF_NAME}-arm64

    publish-frontend:
        needs:
            - publish-backend-manifest
        runs-on: ${{ matrix.runner }}
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix:
                include:
                    - runner: ubuntu-latest
                      platform: linux/amd64
                      arch: amd64
                    - runner: ubuntu-24.04-arm
                      platform: linux/arm64
                      arch: arm64

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 25

            - name: Set up pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Build backend dev image for OpenAPI generation
              run: docker build -t ferron-backend-dev -f ./backend/Dockerfile.dev ./backend

            - name: Create `ferron.kdl` config file
              run: |
                  echo 'include "/etc/ferron-proxy-manager/main.kdl"' > ./backend/ferron.kdl
                  chmod 644 ./backend/ferron.kdl

            - name: Start backend dev container
              run: |
                  docker run -d --name ferron-backend-dev \
                    -p 8000:8000 \
                    -e PRODUCTION=false \
                    -e DATABASE_URL=sqlite+aiosqlite:///./data/ferron.db \
                    -e DATABASE_ECHO=false \
                    -e FERRON_CONTAINER_NAME=ferron \
                    -e AUTH_SECRET_KEY=ci-secret-key \
                    -e AUTH_REFRESH_SECRET_KEY=ci-refresh-secret-key \
                    -e AUTH_SIGNUP_DISABLED=false \
                    -e PUBLIC_AUTH_SIGNUP_DISABLED=false \
                    -e BACKEND_URL=http://backend:8000 \
                    ferron-backend-dev

            - name: Wait for backend OpenAPI endpoint
              run: |
                  for i in $(seq 1 30); do
                    if curl -fsS http://localhost:8000/openapi.json >/dev/null; then
                      exit 0
                    fi
                    sleep 2
                  done
                  echo "Backend did not become ready in time."
                  docker logs ferron-backend-dev
                  exit 1

            - name: Generate frontend API types
              working-directory: ./frontend
              run: |
                  pnpm install --frozen-lockfile
                  pnpm generate:types

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push frontend (${{ matrix.arch }})
              uses: docker/build-push-action@v6
              with:
                  context: ./frontend
                  file: ./frontend/Dockerfile
                  platforms: ${{ matrix.platform }}
                  push: true
                  tags: |
                      kuncodes/ferron-proxy-manager-frontend:${{ github.ref_name }}-${{ matrix.arch }}
                      kuncodes/ferron-proxy-manager-frontend:latest-${{ matrix.arch }}

            - name: Stop backend dev container
              if: always()
              run: docker rm -f ferron-backend-dev || true

    publish-frontend-manifest:
        needs:
            - publish-frontend
        runs-on: ubuntu-latest
        steps:
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Create frontend multi-arch manifests
              run: |
                  docker buildx imagetools create \
                    -t kuncodes/ferron-proxy-manager-frontend:${GITHUB_REF_NAME} \
                    -t kuncodes/ferron-proxy-manager-frontend:latest \
                    kuncodes/ferron-proxy-manager-frontend:${GITHUB_REF_NAME}-amd64 \
                    kuncodes/ferron-proxy-manager-frontend:${GITHUB_REF_NAME}-arm64
